---
- name: Install foreman proxy

  hosts: foreman_proxy

  become: yes

  roles:

    - nephelaiio.plugins
    - nephelaiio.pip
    - diodonfrost.puppet_agent
    - foreman_server_repositories
    - haveged
    - foreman_installer

  vars:

    puppet_version: 6

    foreman_dhcp_from: '128'
    foreman_dhcp_to: '254'
    foreman_proxy_port: 8443
    foreman_domains:
      - "{{ ansible_domain }}"
      - "{{ (ansible_default_ipv4.network + '/' + ansible_default_ipv4.netmask) | ipaddr | ipaddr('revdns') | split_with('.') | tail | join('.') | regex_replace('\\.$', '') }}"
    foreman_subnet: "{{ (ansible_default_ipv4.network + '/' + ansible_default_ipv4.netmask) }}"
    foreman_installer_options:
      - "--no-enable-foreman"
      - "--no-enable-puppet"
      - "--enable-foreman-proxy"
      - "--enable-foreman-proxy-plugin-discovery"
      - "--enable-foreman-proxy-plugin-dns-powerdns"
      - "--foreman-proxy-bind-host 0.0.0.0"
      - "--foreman-proxy-trusted-hosts localhost"
      - "--foreman-proxy-puppet true"
      - "--foreman-proxy-foreman-base-url {{ foreman_url }}"
      - "--foreman-proxy-register-in-foreman true"
      - "--foreman-proxy-bmc true"
      - "--foreman-proxy-dhcp true"
      - "--foreman-proxy-dhcp-interface {{ ansible_default_ipv4.interface }}"
      - "--foreman-proxy-dhcp-network {{ foreman_subnet | ipaddr('network') }}"
      - "--foreman-proxy-dhcp-netmask {{ foreman_subnet | ipaddr('netmask') }}"
      - "--foreman-proxy-dhcp-gateway {{ ansible_default_ipv4.gateway }}"
      - "--foreman-proxy-dhcp-nameservers {{ ansible_dns.nameservers | join(',') }}"
      - "--foreman-proxy-dhcp-range '{{ foreman_subnet | ipaddr(foreman_dhcp_from) | ipaddr('address') }} {{  foreman_subnet | ipaddr(foreman_dhcp_to) | ipaddr('address') }}'"
      - "--foreman-proxy-dns true"
      - "--foreman-proxy-dns-provider powerdns"
      - "--foreman-proxy-plugin-dns-powerdns-backend rest"
      - "--foreman-proxy-plugin-dns-powerdns-rest-api-key {{ foreman_pdns_api_key }}"
      - "--foreman-proxy-plugin-dns-powerdns-rest-url {{ foreman_pdns_url }}/api/v1/servers/localhost"
      - "--foreman-proxy-plugin-discovery-install-images true"
      - "--foreman-proxy-http true"
      - "--foreman-proxy-logs true"
      - "--foreman-proxy-puppet true"
      - "--foreman-proxy-tftp true"
      - "--foreman-proxy-oauth-consumer-key {{ foreman_oauth_consumer_key }}"
      - "--foreman-proxy-oauth-consumer-secret {{ foreman_oauth_consumer_secret }}"
      - "--enable-foreman-proxy-plugin-openscap"
      - "{{ foreman_proxy_trusted_hosts | map('map_format', '--foreman-proxy-trusted-hosts %s') | join(' ') }}"

  pre_tasks:

    - name: create puppet group
      group:
        name: puppet
        local: yes

  tasks:

    - name: install pip requirements
      pip:
        name:
          - apypie
          - urllib3

    - name: create foreman domains
      foreman_domain:
        name: "{{ item }}"
        locations: "{{ foreman_locations }}"
        server_url: "{{ foreman_url }}"
        username: "{{ foreman_admin_user }}"
        password: "{{ foreman_admin_pass }}"
        dns_proxy: "{{ ansible_fqdn }}"
      loop_control:
        label: "{{ item }}"
      loop: "{{ foreman_domains }}"
      tags:
        - domains
        - configure

    - name: create foreman subnets
      foreman_subnet:
        name: "{{ subnet | ipaddr('network') }}/{{ subnet | ipaddr('prefix') }}"
        network: "{{ subnet | ipaddr('network') }}"
        cidr: "{{ subnet | ipaddr('prefix') }}"
        gateway: "{{ ansible_default_ipv4.gateway }}"
        from_ip: "{{ subnet | ipaddr(foreman_dhcp_from) }}"
        to_ip: "{{ subnet | ipaddr(foreman_dhcp_to) }}"
        dns_primary: "{{ ansible_dns.nameservers[0] }}"
        dns_secondary: "{{ ansible_dns.nameservers[1] | default(omit) }}"
        domains: "{{ foreman_domains }}"
        locations: "{{ foreman_locations }}"
        dhcp_proxy: "{{ ansible_fqdn }}"
        tftp_proxy: "{{ ansible_fqdn }}"
        httpboot_proxy: "{{ ansible_fqdn }}"
        discovery_proxy: "{{ ansible_fqdn }}"
        dns_proxy: "{{ ansible_fqdn }}"
        server_url: "{{ foreman_url }}"
        username: "{{ foreman_admin_user }}"
        password: "{{ foreman_admin_pass }}"
      vars:
        subnet: "{{ item | ipaddr }}"
      loop:
        - "{{ foreman_subnet }}"
      tags:
        - subnets
        - configure

    - name: activate host discovery
      foreman_setting:
        name: default_pxe_item_global
        value: discovery
        server_url: "{{ foreman_url }}"
        username: "{{ foreman_admin_user }}"
        password: "{{ foreman_admin_pass }}"
